---
title: "Data Analysis Project Report"
output:
  html_document: 
    theme: readable
    toc: yes
  pdf_document: default
urlcolor: cyan
#bibliography: bibliography.bib
---
***

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
options(scipen = 1, digits = 4, width = 80, fig.align = "center")
```

```{r}
# load libraries to be used throughout the document
library(lmtest)
library(faraway)
```



### Introduction

According to the @nccs, as of 2016, over 1.54 million nonprofit organizations were registered in the United States with the IRS. As is the case for most nonprofit organizations, there is reliance on charitable contributions to ensure their ability to continue to deliver their services and value to their respective communities. To help maximize donation profits for such charities, statistical models can be leveraged to provide a better understanding of their ideal donors. Predictive insights, like being able to predict donation amounts before sending a request via direct mail, could improve donor targeting practices, potentially yielding greater profits while minimizing the efforts of valuable marketing resources. With this project, we will be attempting to build a statistical model capable of doing just this. Specifically, we aim to use donor information, variables in the dataset, from a national veterans' agency to predict the amount (in dollars) of each donor's current contribution to said national veteran's agency.



### Methods



##### Data File Description

- File Information
  - Name: `nvo.txt`
  - Type: standard text document
  - Encoding: UTF-8
  - Delimitation Method: Tab
- Dataset Characteristics
  - Each record contains information about a donor that has made charitable contributions to a national veteran's agency
  - 7600 records
  - 19 variables
    - 17 numeric variables _(6 of these will be ignored for this analysis)_
    - 2 categorical variables
- Variables of Interest
  - Response Variable
    - `Current.Gift`: the amount of the donor's current donation (in dollars).
  - Explanatory Variables
    - `Age`: the age of the donor
    - `Own.Home.`: a categorical variable regarding whether or not the donor owns a home
    - `Num.Children`: the number of children, if any, that the donor has
    - `Total.Wealth`: a wealth rating from 0-9 (with 9 being the wealthiest) that is based on median family income and population statistics
    - `Sex`: the gender of the donor
    - `Number.of.Gifts`: the number of donations made
    - `Time.Between.Gifts`: the avg number of months between donations
    - `Largest.Gift`: the largest donation made (in dollars)
    - `Smallest.Gift`: the smallest donation made (in dollars)
    - `Other.Gifts`: number of times the donor has responded to a mail order donation offer
    - `Average.Gift`: the avg donation amount (in dollars) from a donor 


##### Data Preparation

```{r}
nvo_data = read.table("nvo.txt", sep = "\t",header = TRUE, fileEncoding = "UTF-8")

# remove unnecessary columns from data to make model selection easier later on
nvo_cur_data = subset(nvo_data, select = -c(
	Average.Gift
	,Income
	,Sqrt.Smallest.Gift
	,Sqrt.Current.Gift
	,Sqrt.Largest.Gift
	,Sqrt.Previous.Gift
	,Sqrt.Average.Gift)
	)

# coerce categorical variables into a factor
nvo_data$Sex = as.factor(nvo_data$Sex)
nvo_data$Own.Home. = as.factor(nvo_data$Own.Home.)
nvo_data$Total.Wealth = as.factor(nvo_data$Total.Wealth)

# we are only interested in predicting size of gifts received, not gifts not received
nvo_cur_data = nvo_cur_data[nvo_cur_data$Current.Gift > 0, ]

# this being 0 doesn't make sense. 0 time between 2 gifts should just be 1 larger gift
nvo_cur_data = nvo_cur_data[nvo_cur_data$Time.Between.Gifts > 0, ]

# people should only be in the dataset if they have contributed before
# their smallest and largest gifts would be > 0 logically
nvo_cur_data = nvo_cur_data[nvo_cur_data$Smallest.Gift > 0, ]
nvo_cur_data = nvo_cur_data[nvo_cur_data$Largest.Gift > 0, ]
```

###### Functions

```{r}
# functions to be used throughout the document

# calculates LOOCV RMSE for a Model
get_loocv_rmse = function(model) {
  sqrt(mean((resid(model) / (1 - hatvalues(model))) ^ 2))
}

# calculates Adjusted R Squared Value for a Model
get_adj_r2 = function(model) {
  summary(model)$adj.r.squared
}


# finds observations with leverage greater than 2 times the average leverage
get_high_leverage = function(model){
  hatvalues(model) > 2 * mean(hatvalues(model))
}

# finds observations with a standardized residual greater than a magnitude of 2
get_outliers = function(model){
  abs(rstandard(model)) > 2
}

# finds observations with a cooks.distance greater than 4 / number of observations
get_high_influcence = function(model){
  cooks.distance(model) > 4 / length(cooks.distance(model))
}

# uses Breusch-Pagan Test to validate Constant Variance assumption
get_bp_p_value = function(model) {
  unname(bptest(model)$p.value)
}

# uses Shapiro-Wilkes Test to validate Normality Assumption
get_sw_p_value = function(model) {
	if (length(resid(model)) > 5000) {
		p_val = shapiro.test(sample(resid(model),5000))$p.value
	} else {
		p_val = shapiro.test(resid(model))$p.value
	}
	unname(p_val)
}

# returns fitted versus residuals and Q-Q plots
diagnostic_plots = function(model, pcol = "grey", lcol = "dodgerblue") {

	par(mfrow=c(1,2))
	# A fitted versus residuals plot
	plot(fitted(model), resid(model), col = pcol, pch = 20,
		xlab = "Fitted", ylab = "Residuals", main = "Fitted vs Residuals Plot")
	abline(h = 0, col = lcol, lwd = 2)
	# A Normal Q-Q plot
	qqnorm(resid(model), main = "Normal Q-Q Plot", col = pcol)
	qqline(resid(model), col = lcol, lwd = 2)

}

# returns p-values of Breusch-Pagan and Shapiro-Wilkes tests 
get_model_diagnostics = function(model, pcol = "grey", lcol = "dodgerblue", plot_it = FALSE) {
	if (plot_it == TRUE) {
		diagnostic_plots(model, pcol, lcol)
	}
	res = c("BP Test P-Value" = get_bp_p_value(model),"SW Test P-Value" = get_sw_p_value(model)) 
	res
}

# returns LOOCV_RMSE and Adj. R-Squared values
evaluate_model = function(model) {
	res = c("LOOCV_RMSE" = get_loocv_rmse(model),"Adj. R-squared" = get_adj_r2(model)) 
	res
}
```




